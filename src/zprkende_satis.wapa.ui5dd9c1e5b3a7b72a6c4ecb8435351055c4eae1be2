sap.ui.define(                                                                                                                                                                                                                                                 
  [                                                                                                                                                                                                                                                            
    "sap/ui/core/mvc/Controller",                                                                                                                                                                                                                              
    "sap/ui/model/json/JSONModel",                                                                                                                                                                                                                             
    "sap/f/library",                                                                                                                                                                                                                                           
    "sap/m/MessageBox",                                                                                                                                                                                                                                        
    "sap/ui/core/Fragment",                                                                                                                                                                                                                                    
    "test/model/formatter",                                                                                                                                                                                                                                    
    "sap/m/MessageToast",                                                                                                                                                                                                                                      
    "sap/ui/model/resource/ResourceModel",                                                                                                                                                                                                                     
  ],                                                                                                                                                                                                                                                           
  function (                                                                                                                                                                                                                                                   
    Controller,                                                                                                                                                                                                                                                
    JSONModel,                                                                                                                                                                                                                                                 
    library,                                                                                                                                                                                                                                                   
    MessageBox,                                                                                                                                                                                                                                                
    Fragment,                                                                                                                                                                                                                                                  
    formatter,                                                                                                                                                                                                                                                 
    MessageToast,                                                                                                                                                                                                                                              
    ResourceModel                                                                                                                                                                                                                                              
  ) {                                                                                                                                                                                                                                                          
    "use strict";                                                                                                                                                                                                                                              
    let sepetAdet;                                                                                                                                                                                                                                             
    let adet;                                                                                                                                                                                                                                                  
    let tableItemsArray = [];                                                                                                                                                                                                                                  
    var oModel;                                                                                                                                                                                                                                                
    let aBasket;                                                                                                                                                                                                                                               
    return Controller.extend("test.controller.View4", {                                                                                                                                                                                                        
      onInit: function () {                                                                                                                                                                                                                                    
        var oModelSepet = this.getOwnerComponent().getModel("AddBasket")                                                                                                                                                                                       
        var sepettekiUrunler = oModelSepet.getProperty("/sepet/sepet");                                                                                                                                                                                        
        if (sepettekiUrunler) {                                                                                                                                                                                                                                
          sepettekiUrunler.forEach(function (item) {                                                                                                                                                                                                           
            item.DiscountedTutar = item.tutar;                                                                                                                                                                                                                 
            item.BirimDiscountedTutar = item.Tutar;                                                                                                                                                                                                            
          });                                                                                                                                                                                                                                                  
        } else {                                                                                                                                                                                                                                               
          // If the basket is empty, navigate to "view1" and reset everything                                                                                                                                                                                  
          this.getOwnerComponent().getRouter().navTo("RouteView1", {}, true);                                                                                                                                                                                  
          this.onClearBasket();                                                                                                                                                                                                                                
        };                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
        var oRouter = sap.ui.core.UIComponent.getRouterFor(this);                                                                                                                                                                                              
        oRouter                                                                                                                                                                                                                                                
          .getRoute("RouteView4")                                                                                                                                                                                                                              
          .attachMatched(this._onRouteMatched, this);                                                                                                                                                                                                          
        oModel = this.getOwnerComponent().getModel("AddBasket");                                                                                                                                                                                               
      },                                                                                                                                                                                                                                                       
      //! Formatter'Ä± kullanarak para birimini biÃ§imleme iÅlevi                                                                                                                                                                                             
      formatCurrency: function (amount) {                                                                                                                                                                                                                      
        return formatter.formatCurrency(amount);                                                                                                                                                                                                               
      },                                                                                                                                                                                                                                                       
      _onRouteMatched: function (oEvent) {                                                                                                                                                                                                                     
        var oArgs, oView;                                                                                                                                                                                                                                      
        oArgs = oEvent.getParameter("arguments");                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
        // GÃ¶nderilen parametreyi burada alabilirsiniz                                                                                                                                                                                                        
        var param = oArgs.param;                                                                                                                                                                                                                               
        if (param) {                                                                                                                                                                                                                                           
          oModel = this.getOwnerComponent().getModel("AddBasket");                                                                                                                                                                                             
        } else {                                                                                                                                                                                                                                               
        }                                                                                                                                                                                                                                                      
      },                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                               
      // AlÄ±nan parametreyi kullanmak iÃ§in gerekli iÅlemleri yapabilirsiniz                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
      currentChangeHandler: function (oEvent) {                                                                                                                                                                                                                
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                                                                                               
        adet = oEvent.mParameters.value;                                                                                                                                                                                                                       
        // Retrieve the value of "idBagliTutar" from the view                                                                                                                                                                                                  
                                                                                                                                                                                                                                                               
        var fPrice = oModel.getProperty(                                                                                                                                                                                                                       
          oEvent.getSource().getBindingContext("AddBasket").getPath() + "/Tutar"                                                                                                                                                                               
        );                                                                                                                                                                                                                                                     
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                                                                                                     
        var sPath = oEvent.getSource().getBindingContext("AddBasket").getPath();                                                                                                                                                                               
        var fResult = adet * parseFloat(fPrice);                                                                                                                                                                                                               
        // var fResult2 = adet * parseFloat(fPrice2);                                                                                                                                                                                                          
        var formattedResult = fResult.toFixed(3);                                                                                                                                                                                                              
        // var formattedResult2 = fResult2.toFixed(3);                                                                                                                                                                                                         
                                                                                                                                                                                                                                                               
        var fKDV = oModel.getProperty(                                                                                                                                                                                                                         
          oEvent.getSource().getBindingContext("AddBasket").getPath() + "/Kdv"                                                                                                                                                                                 
        );                                                                                                                                                                                                                                                     
        var fKDVResult = adet * parseFloat(fKDV);                                                                                                                                                                                                              
        var formattedKDVResult = fKDVResult.toFixed(3);                                                                                                                                                                                                        
                                                                                                                                                                                                                                                               
        var fToplamKDVsiz = oModel.getProperty(                                                                                                                                                                                                                
          oEvent.getSource().getBindingContext("AddBasket").getPath() + "/Price"                                                                                                                                                                               
        );                                                                                                                                                                                                                                                     
        var fKDVsizTopResult = adet * parseFloat(fToplamKDVsiz);                                                                                                                                                                                               
        var formattedKDVsizTopResult = fKDVsizTopResult.toFixed(3);                                                                                                                                                                                            
                                                                                                                                                                                                                                                               
        oModel.setProperty(sPath + "/tutar", formattedResult);                                                                                                                                                                                                 
        oModel.setProperty(sPath + "/BirimToplamTutar", formattedResult);                                                                                                                                                                                      
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                                                                                                     
        oModel.setProperty(sPath + "/toplamKDV", formattedKDVResult);                                                                                                                                                                                          
        oModel.setProperty(                                                                                                                                                                                                                                    
          sPath + "/toplamKDVsizFiyat",                                                                                                                                                                                                                        
          formattedKDVsizTopResult                                                                                                                                                                                                                             
        );                                                                                                                                                                                                                                                     
        oModel.setProperty(sPath + "/count", adet);                                                                                                                                                                                                            
                                                                                                                                                                                                                                                               
        oModel.refresh();                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                               
        aBasket = this.getView()                                                                                                                                                                                                                               
          .getModel("AddBasket")                                                                                                                                                                                                                               
          .getProperty("/sepet/sepet");                                                                                                                                                                                                                        
        var productsTotalPrice = aBasket.reduce(                                                                                                                                                                                                               
          (acc, item) => (parseFloat(acc) + parseFloat(item.tutar)).toString(),                                                                                                                                                                                
          "0"                                                                                                                                                                                                                                                  
        );                                                                                                                                                                                                                                                     
        var totalPriceWithoutVAT = aBasket.reduce(                                                                                                                                                                                                             
          (acc, item) =>                                                                                                                                                                                                                                       
            (parseFloat(acc) + parseFloat(item.toplamKDVsizFiyat)).toString(),                                                                                                                                                                                 
          "0"                                                                                                                                                                                                                                                  
        );                                                                                                                                                                                                                                                     
        var productsTotalVAT = aBasket.reduce(                                                                                                                                                                                                                 
          (acc, item) =>                                                                                                                                                                                                                                       
            (parseFloat(acc) + parseFloat(item.toplamKDV)).toString(),                                                                                                                                                                                         
          "0"                                                                                                                                                                                                                                                  
        );                                                                                                                                                                                                                                                     
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                                                                                                           
        // todo burada sepet icindeki degerleri hesapla                                                                                                                                                                                                        
        oModel.setProperty("/ProductsTotalPrice", productsTotalPrice);                                                                                                                                                                                         
        oModel.setProperty("/TotalPriceWithoutVAT", totalPriceWithoutVAT);                                                                                                                                                                                     
        oModel.setProperty("/ProductsTotalVAT", productsTotalVAT);                                                                                                                                                                                             
                                                                                                                                                                                                                                                               
      },                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                               
      handleDelete: function (oEvent) {                                                                                                                                                                                                                        
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                                                                                                                 
        var listItem = oEvent.getParameter("listItem");                                                                                                                                                                                                        
        var table = this.getView().byId("idSepetTable");                                                                                                                                                                                                       
        var items = table.getItems();                                                                                                                                                                                                                          
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                                                                                                           
        if (items.length === 1) {                                                                                                                                                                                                                              
          this.onClearBasket();                                                                                                                                                                                                                                
        } else {                                                                                                                                                                                                                                               
          var delProductId = listItem                                                                                                                                                                                                                          
            .getBindingContext("AddBasket")                                                                                                                                                                                                                    
            .getProperty("id");                                                                                                                                                                                                                                
          //model Ã¼zerinden silme iÅlemi                                                                                                                                                                                                                     
          aBasket = this.getView()                                                                                                                                                                                                                             
            .getModel("AddBasket")                                                                                                                                                                                                                             
            .getProperty("/sepet/sepet");                                                                                                                                                                                                                      
          aBasket = aBasket.filter(function (item) {                                                                                                                                                                                                           
            return item.id !== delProductId;                                                                                                                                                                                                                   
          });                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                               
          this.getView()                                                                                                                                                                                                                                       
            .getModel("AddBasket")                                                                                                                                                                                                                             
            .setProperty("/sepet/sepet", aBasket);                                                                                                                                                                                                             
          oModel.refresh();                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                               
          this.calcTotal();                                                                                                                                                                                                                                    
        }                                                                                                                                                                                                                                                      
      },                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                               
      calcTotal: function () {                                                                                                                                                                                                                                 
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                                                                                                     
        aBasket = this.getView()                                                                                                                                                                                                                               
          .getModel("AddBasket")                                                                                                                                                                                                                               
          .getProperty("/sepet/sepet");                                                                                                                                                                                                                        
        // var sepetData = this.getOwnerComponent().getModel("AddBasket").oData.sepet.sepet;                                                                                                                                                                   
        var sepetUrunCesidSayisi = aBasket.length;                                                                                                                                                                                                             
        var newSepetData = aBasket.map((item) => ({ ...item }));                                                                                                                                                                                               
        if (newSepetData) {                                                                                                                                                                                                                                    
          var productsTotalPrice = newSepetData.reduce(                                                                                                                                                                                                        
            (acc, item) =>                                                                                                                                                                                                                                     
              (parseFloat(acc) + parseFloat(item.tutar)).toString(),                                                                                                                                                                                           
            "0"                                                                                                                                                                                                                                                
          );                                                                                                                                                                                                                                                   
          var totalPriceWithoutVAT = newSepetData.reduce(                                                                                                                                                                                                      
            (acc, item) =>                                                                                                                                                                                                                                     
              (parseFloat(acc) + parseFloat(item.toplamKDVsizFiyat)).toString(),                                                                                                                                                                               
            "0"                                                                                                                                                                                                                                                
          );                                                                                                                                                                                                                                                   
          var productsTotalVAT = newSepetData.reduce(                                                                                                                                                                                                          
            (acc, item) =>                                                                                                                                                                                                                                     
              (parseFloat(acc) + parseFloat(item.toplamKDV)).toString(),                                                                                                                                                                                       
            "0"                                                                                                                                                                                                                                                
          );                                                                                                                                                                                                                                                   
          oModel.setProperty("/ProductsTotalPrice", productsTotalPrice);                                                                                                                                                                                       
          oModel.setProperty("/TotalPriceWithoutVAT", totalPriceWithoutVAT);                                                                                                                                                                                   
          oModel.setProperty("/ProductsTotalVAT", productsTotalVAT);                                                                                                                                                                                           
          oModel.setProperty("/ProductsArtNumber", sepetUrunCesidSayisi);                                                                                                                                                                                      
        } else {                                                                                                                                                                                                                                               
          oModelSepet.setProperty("/ProductsTotalPrice", 0);                                                                                                                                                                                                   
        }                                                                                                                                                                                                                                                      
        if (aBasket.length === 0) {                                                                                                                                                                                                                            
          this.getOwnerComponent().getRouter().navTo("RouteView1", {}, true);                                                                                                                                                                                  
          this.onClearBasket();                                                                                                                                                                                                                                
        }                                                                                                                                                                                                                                                      
        // this.getView().byId("idTotalText").setNumber(total);                                                                                                                                                                                                
        // this.oModelSepet.setProperty("/sepet/sepet", items);                                                                                                                                                                                                
      },                                                                                                                                                                                                                                                       
      goLogin: function () {                                                                                                                                                                                                                                   
        this.getView().getModel("AddBasket").setProperty("/options", {                                                                                                                                                                                         
          Fiyat: "",                                                                                                                                                                                                                                           
          YÃ¼zde: "",                                                                                                                                                                                                                                          
        });                                                                                                                                                                                                                                                    
        this.getOwnerComponent().getRouter().navTo("RouteView2");                                                                                                                                                                                              
      },                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                               
      goView1: function () {                                                                                                                                                                                                                                   
        setTimeout(() => {                                                                                                                                                                                                                                     
          this.getOwnerComponent().getRouter().navTo("RouteView1", {                                                                                                                                                                                           
            param: "test",                                                                                                                                                                                                                                     
          });                                                                                                                                                                                                                                                  
        }, 200);                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
        // this.getOwnerComponent().getRouter().navTo("RouteView1", {}, true);                                                                                                                                                                                 
      },                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                               
      onClearBasket: function () {                                                                                                                                                                                                                             
        var oModelSepet = this.getOwnerComponent().getModel("AddBasket");                                                                                                                                                                                      
        oModelSepet.setProperty("/odemeSekli", "Nakit");                                                                                                                                                                                                       
        oModelSepet.setProperty("/PaymentType", "1");                                                                                                                                                                                                          
        oModelSepet.setProperty("/inputsVisible", false);                                                                                                                                                                                                      
        oModelSepet.setProperty("/step0", false);                                                                                                                                                                                                              
        oModelSepet.setProperty("/step1", false);                                                                                                                                                                                                              
        oModelSepet.setProperty("/step2", false);                                                                                                                                                                                                              
        oModelSepet.setProperty("/step3", false);                                                                                                                                                                                                              
        oModelSepet.setProperty("/updateEnable", false);                                                                                                                                                                                                       
        oModelSepet.setProperty("/createEnable", false);                                                                                                                                                                                                       
        oModelSepet.setProperty("/sepet/sepet", []);                                                                                                                                                                                                           
        oModelSepet.setProperty("/ProductsTotalPrice", 0);                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
        var sMessage = "Aliseris Sepeti Temizlendi";                                                                                                                                                                                                           
        MessageToast.show(sMessage);                                                                                                                                                                                                                           
        setTimeout(() => {                                                                                                                                                                                                                                     
          this.getOwnerComponent().getRouter().navTo("RouteView1", {                                                                                                                                                                                           
            param: "test",                                                                                                                                                                                                                                     
          });                                                                                                                                                                                                                                                  
        }, 1000);                                                                                                                                                                                                                                              
      },                                                                                                                                                                                                                                                       
    });                                                                                                                                                                                                                                                        
  }                                                                                                                                                                                                                                                            
);                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                               